---
layout: post
title: 百度贴吧在flutter上的实践
category: 
 - 综述
tags:
 - flutter
---

# 百度贴吧在flutter上的实践

[TOC]

## 贴吧flutter团队介绍

贴吧成立了跨平台小组致力于跨平台方案的研究，聚焦于flutter平台化、动态化的研究和落地，以及针对flutter开发过程中的痛点和不足提供开源解决方案。

## Why Flutter?

自18年Q3开始，flutter相继发布了预览版和release版本，致力于建设一个立足于Android、iOS、web、PC、Fuchsia平台之上的跨平台解决方案。Write once ，Run anywhere，是继React Native以来又一项掀起跨平台风潮的技术。对比之前的H5 + WebView渲染和JS + 原生渲染的跨平台解决方案，flutter具有以下的优势：

* skia自绘引擎，跨平台能力强
* 支持AOT和JIT编译方式
* Dart语言支持
* 效率高
* 一套代码，多端一致性
* 社区成长迅速，关注度高

贴吧对于跨平台的诉求和flutter的愿景是一致的，因此选用flutter作为跨平台方案的核心层。

## 贴吧在flutter上的探索和实践

### 架构

贴吧内部版是贴吧的纯flutter版本，是完全基于flutter构建的简版贴吧，目前覆盖Android、iPhone和iPad三端。下图是贴吧内部版的总体架构，分为三层四部分，具体就是：

* **flutter平台层**

  提供flutter的基础平台能力，包括flutter提供的Framework层以及底层engine和platform。

* **动态化**

  flutter官方由于多方面的考虑暂时停止了对flutter动态化的支持，但是在国内动态化是一个强需求，我们有专门的技术小组去解决这个问题，目前Android上面已经有一定的进展，iOS还未有比较好的解决方案。

* **基础能力层**

  基础能力层包括自建的、对系统能力封装、以及对第三方插件优化的基础能力提供，包括网络（基于dio优化）、状态管理（基于provider和redux优化）、视频（基于第三方插件优化）、图片（基于系统图片优化）、富文本（自建）、推送（百度内部能力插件封装）等

* **业务层**

  * **业务相关基础能力**

    业务相关基础能力负责提供基础的账号、广告、UI组件化、监控平台、日志平台等核心能力

  * **核心业务**

    这部分是我们整体的业务所在，包括首页、进吧页、吧页面、帖子详情页、个人中心页面等


![image-20190806142639480](/Users/diwenchao/Library/Application Support/typora-user-images/image-20190806142639480.png)

### 实践情况

贴吧内部版1.0.0版本在5月24日三端陆续上线，整个开发周期从立项到上线总共耗费4人力两个月，效率很高，当前迭代版本是1.0.5，可以到各大应用商店下载体验。

#### 线上表现

我们这里主要谈一下flutter的稳定性，在规避了一些engine侧必现的crash以外，整体的稳定性表现是非常好的，尤其是在Android端，稳定性的表现甚至超出预期。

#### 技术积累

这部分基本涵盖了贴吧内部版所有基础能力支持，其中有完全自建的能力，有对百度内部服务封装的插件，有对系统能力做的拆分和优化，有对第三方插件做的优化。

| 所属方向| 功能模块 |
| - | - |
| 整体框架| 状态管理、日志系统等 |
| 百度内部基础设施建设  | 账号插件、异常监控插件、推送插件等 |
| 第三方基础设施建设 | 网络加载框架、富文本、视频服务、页面管理、schema、webview、分享、图片选择和保存等 |
| 基于系统能力的封装 | 图片加载框架、栈管理等   |
| UI组件化| 色值规范、尺寸适配、卡片组件化、图片组件、视频组件、大图组件、loading组件、按钮组件、弹窗组件等 |
| 效率工具 | 抓包、自动构建等 |

### 存在的问题

当前flutter稳定版的SDK更新到了1.7，迭代的速度也很快，但是过程中我们发现了几个问题：

- engine侧测试力度不足导致的某些情况下的crash
- engine侧的升级会造成解决一个问题，又引入一个新的问题的情况
- 前期由于某些功能的不支持我们修改了一部分的源码，SDK升级后带来一些适配上的工作
- flutter某些widget的适配性不好，功能提供不够全面
- 第三方插件质量良莠不齐

以上问题是确切存在的，但是对于一个新兴的框架又是不可避免的，好在flutter的迭代速度比较快，社区也比较活跃，多数问题是能得到快速解决的，但是在日常开发中，改动源码来获取某些功能的做法还是避免不了的。

### 规划

目前flutter web端已经进入内侧阶段，我们下一步的规划是覆盖web端，进行web端的尝试和技术积累，一起推动flutter技术的发展和社区的成熟。